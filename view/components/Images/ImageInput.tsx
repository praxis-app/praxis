// TODO: Research alternatives or libraries for image inputs
// TODO: Remove unneeded refreshKey prop - use key prop instead

import { Image } from '@mui/icons-material';
import { Box, BoxProps, IconButton, SxProps } from '@mui/material';
import { ChangeEvent, useRef } from 'react';
import { useTranslation } from 'react-i18next';

interface Props extends Omit<BoxProps, 'onChange'> {
  multiple?: boolean;
  name?: string;
  onChange?: (images: File[]) => void;
  refreshKey?: string;
  setImage?: (image: File) => void;
  setImages?: (images: File[]) => void;
  iconStyles?: SxProps;
  disabled?: boolean;
}

const ImageInput = ({
  children,
  multiple,
  name,
  onChange,
  refreshKey,
  setImage,
  setImages,
  iconStyles,
  disabled,
  ...boxProps
}: Props) => {
  const imageInput = useRef<HTMLInputElement>(null);
  const { t } = useTranslation();

  const setImageState = (files: File[]) => {
    if (multiple && setImages) {
      setImages(files);
    } else if (setImage) {
      setImage(files[0]);
    }
  };

  const handleChange = ({ target }: ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(target.files || []);
    setImageState(files);

    if (onChange) {
      onChange(files);
    }
  };

  const handleClick = () => {
    if (disabled || !imageInput.current) {
      return;
    }
    imageInput.current.click();
  };

  const renderContent = () => {
    if (children) {
      return children;
    }
    return (
      <IconButton
        aria-label={t('images.labels.attachImages')}
        disabled={disabled}
        disableRipple
        edge="start"
      >
        <Image sx={{ fontSize: 40, ...iconStyles }} />
      </IconButton>
    );
  };

  return (
    <Box marginTop={0.35} {...boxProps}>
      <input
        accept="image/*"
        key={refreshKey}
        multiple={multiple}
        name={name}
        onChange={handleChange}
        ref={imageInput}
        style={{ display: 'none' }}
        type="file"
      />
      <Box onClick={handleClick}>{renderContent()}</Box>
    </Box>
  );
};

export default ImageInput;
